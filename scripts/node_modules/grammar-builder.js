var fs = require('fs');
var node_path = require('path');

var peg = require('pegjs');



function requirePath(path) {
	return require(path.join('/'));
}

function getPath(parts) {
	return node_path.join.apply(node_path, parts);
}

function read(path) {
	return fs.readFileSync(getPath(path), 'utf-8');
}

function write(path, data) {
	fs.writeFileSync(getPath(path), data);
}

function build(name) {
	// ------------------------------------------------------------------- Paths

	var rootPath = [__dirname, '..', '..'];
	var basePath = rootPath.concat(['app', 'node_modules', 'modes', name, 'parser']);
	var optionsPath = basePath.concat('options');
	var grammarPath = basePath.concat('grammar.pegjs');
	var parserPath = basePath.concat('grammar.js');

	// ------------------------------------------------------------------ Inputs

	var options = requirePath(optionsPath);
	var grammar = read(grammarPath);

	// -------------------------------------------------------------- Processing

	options.output = 'source';
	var source = peg.buildParser(grammar, options);
	source = 'module.exports = ' + source;

	// ----------------------------------------------------------------- Outputs

	write(parserPath, source);
}



exports.build = build;
